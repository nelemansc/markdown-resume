name: Document Conversion

on: push

permissions:
  contents: read
  id-token: write

jobs:
  convert_via_pandoc:
    name: Convert resume from markdown to pdf via Pandoc and ConTeXt
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - name: Create output directory
        run: mkdir -p output

      - name: Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y context pandoc texlive-luatex texlive-context

      - name: Convert Markdown to ConTeXt
        run: |
          pandoc --verbose --standalone --template=styles/chmduquesne.tex --from markdown --to context --variable papersize=A4 --output=output/resume.tex markdown/resume.md

      - name: Compile PDF with ConTeXt
        run: |
          cd output && context resume.tex --result=resume.pdf

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify PDF was created
        run: |
          if [ ! -f output/resume.pdf ]; then
            echo "Error: resume.pdf was not created"
            exit 1
          fi
          echo "PDF created successfully"
          ls -la output/

      - name: Upload PDF to S3
        run: |
          aws s3 sync output/ s3://${{ secrets.AWS_S3_BUCKET }}/assets/ --acl public-read --follow-symlinks

      - name: Invalidate CloudFront Distribution
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"
